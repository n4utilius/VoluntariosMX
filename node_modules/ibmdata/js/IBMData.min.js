/*!
 *  Licensed Materials - Property of IBM
 *  5725-I43 (C) Copyright IBM Corp. 2011, 2014. All Rights Reserved.
 *  US Government Users Restricted Rights - Use, duplication or
 *  disclosure restricted by GSA ADP Schedule Contract with IBM Corp.
 *
 *  IBM Mobile Cloud Services, 
 *  IBMData Service JavaScript SDK v0.3.2
 *
 */
(function(a,b){var c=!("function"!=typeof define||!define.amd),d="object"==typeof exports,e=function(){/**
 * @license almond 0.2.9 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */
var a,c,d;return function(b){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=s.map,p=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(n=n.slice(0,n.length-1),a=a.split("/"),g=a.length-1,s.nodeIdCompat&&w.test(a[g])&&(a[g]=a[g].replace(w,"")),a=n.concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||p)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&p&&p[d]&&(i=p[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function g(a,c){return function(){return n.apply(b,v.call(arguments,0).concat([a,c]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(a){if(e(r,a)){var c=r[a];delete r[a],t[a]=!0,m.apply(b,c)}if(!e(q,a)&&!e(t,a))throw new Error("No "+a);return q[a]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(a,c,d,f){var h,k,l,m,n,s,u=[],v=typeof d;if(f=f||a,"undefined"===v||"function"===v){for(c=!c.length&&d.length?["require","exports","module"]:c,n=0;n<c.length;n+=1)if(m=o(c[n],f),k=m.f,"require"===k)u[n]=p.require(a);else if("exports"===k)u[n]=p.exports(a),s=!0;else if("module"===k)h=u[n]=p.module(a);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(a+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=d?d.apply(q[a],u):void 0,a&&(h&&h.exports!==b&&h.exports!==q[a]?q[a]=h.exports:l===b&&s||(q[a]=l))}else a&&(q[a]=d)},a=c=n=function(a,c,d,e,f){if("string"==typeof a)return p[a]?p[a](c):j(o(a,c).f);if(!a.splice){if(s=a,s.deps&&n(s.deps,s.callback),!c)return;c.splice?(a=c,c=d,d=null):a=b}return c=c||function(){},"function"==typeof d&&(d=e,e=f),e?m(b,a,c,d):setTimeout(function(){m(b,a,c,d)},4),n},n.config=function(a){return n(a)},a._defined=q,d=function(a,b,c){b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},d.amd={jQuery:!0}}(),d("almond",function(){}),d("ibm/baas/utils",["require","exports","module"],function(){function a(a){var b="";for(prop in a){var c=a[prop];_.isUndefined(c)||_.isNull(c)||(b=b+prop+"="+c+"&")}return b.substring(0,b.length-1)}function b(a,b){return _.isObject(a)?(_.isArray(b)||(b=[b]),b.every(function(b){var c=a[b];return _.isNull(c)||_.isUndefined(c)?(console.warn("Object %o is missing field: %s",a,b),!1):!0})):!1}function c(a,b,c){var d=c||{};return _.isFunction(b)||(d=b,b=d.constructor,delete d.constructor),b.prototype=Object.create(a.prototype),Object.defineProperty(b.prototype,"constructor",{enumerable:!1,value:b}),_.extend(b.prototype,d),b}return{inherit:c,hasFields:b,toQueryString:a}}),d("ibm/baas/service/data/error/IBMError",["require","exports","module","../../../utils"],function(a,b,c,d){function e(a){var b=a||{};_.isString(b)&&(b={message:a}),b.message=b.message||"";var c=new Error(b.message);c&&c.stack&&(b.stack=c.stack),Object.keys(b).forEach(function(a){this[a]=b[a]}.bind(this))}return e.inherit=function(a){function b(a){return function(){e.apply(this,_.toArray(arguments)),this.name=a}}var c,f=a||{};return _.isFunction(f)?(c=f,f=arguments[1]||{},f.constructor=c):c=f.constructor,c===Object?c=f.constructor=b(f.name||e.name):f.name||(f.name=c.name&&"Object"!==c.name&&"Function"!==c.name?c.name:e.name),d.inherit(e,c,f)},d.inherit(Error,e,{name:"IBMError",toString:function(){return this.name+" - "+this.message}})}),d("ibm/baas/service/data/error/IBMDataError",["require","exports","module","./IBMError"],function(a,b,c,d){var e=d.inherit({constructor:function(){d.apply(this,_.toArray(arguments))}});return e}),d("ibm/baas/service/data/comm/_DataServiceRequest",["require","exports","module","../error/IBMError"],function(a,b,c,d){function e(a){this.serviceUrl=a}var f={UPDATE:"UPDATE",READ:"READ",DELETE:"DELETE",CREATE:"CREATE",QUERY:"QUERY"},g={invalidOp:"Invalid operation provided: ",unimplementedRequest:"Request hasn't been implemented"};return e.OP=f,e.setRequester=function(a){this.requester=a},e.getRequester=function(){if(!this.requester)throw new d("Request class not set. SDK was likely not initialized.");return this.requester},e.prototype={OP:e.OP,send:function(){return console.error("Request send method not implemented"),Q.reject(g.unimplementedRequest)}},e}),d("ibm/baas/service/data/IBMObject",["require","exports","module","../../utils","./error/IBMDataError","./comm/_DataServiceRequest"],function(a,b,c,d,e,f){function g(a){this._meta={className:a,objectId:null,version:null,createdAt:null,modifiedAt:null,deleted:!1},this.attributes={}}var h=f.OP,i=function(a){return new e({name:"UnexpectedError",message:a})},j=function(a,b,c){return new e({message:"Unable to perform operation("+a+"): "+b,isDeleted:c===!0?!0:!1})},k=function(){return i("Invalid or null object returned from server.")};return g.prototype={constructor:g,save:function(){var a=h.UPDATE;return this.getId()||(a=h.CREATE),this._asyncOp(a)},del:function(){return this._asyncOp(h.DELETE)},read:function(){if(!this.getId()){var a="Object must have id.";return this.isDeleted&&(a="Object has been deleted"),Q.reject(j(h.READ,a,this.isDeleted()))}return this._asyncOp(h.READ)},set:function(a,b){if(_.isObject(a)){var c=a;for(var d in c)this._set(d,c[d])}else this._set(a,b)},_set:function(a,b){this.attributes[a]=b},get:function(a){return _.isString(a)?this.attributes[a]:this.attributes},getId:function(){return this.getMetadata("objectId")},getClassName:function(){return this.getMetadata("className")},getAttributes:function(){return console.warn("Use .get() now"),console.trace(),this.get()},getMetadata:function(a){return _.isString(a)?this._meta[a]:this._meta},isDeleted:function(){return this.getMetadata("deleted")},_asyncOp:function(a){return this.isDeleted()?Q.reject(a,"Object has been deleted.",!0):this.requester.send(this,a).then(this._onOpSuccess(a))},_onOpSuccess:function(a){var b;switch(a){case h.CREATE:b=this._onCreate;break;case h.UPDATE:b=this._onUpdate;break;case h.DELETE:b=this._onDelete;break;case h.READ:b=this._onRead;break;default:b=function(){return Q.reject(i("Unhandled op: "+a))}}return b.bind(this)},_onCreate:function(a){return this._updateWithServerVersion(a),Q.resolve(this)},_onRead:function(a){return this._updateWithServerVersion(a),Q.resolve(this)},_onUpdate:function(a){return this._updateWithServerVersion(a),Q.resolve(this)},_onDelete:function(){return _.keys(this._meta).forEach(function(a){this._meta[a]=null}.bind(this)),this._meta.deleted=!0,this.attributes={},Q.resolve(this)},_updateWithServerVersion:function(a){this._meta;if(!d.hasFields(a,["objectId","createdAt","modifiedAt","version","attributes"]))throw k();this.attributes=a.attributes,this._meta.version=a.version,this._meta.objectId=a.objectId,this._meta.createdAt=a.createdAt,this._meta.modifiedAt=a.modifiedAt}},Object.defineProperties(g.prototype,{requester:{enumerable:!1,get:function(){return this.__req||(this.__req=f.getRequester()),this.__req},set:function(a){this.__req=a}},__req:{enumerable:!1,writable:!0}}),g}),d("ibm/baas/service/data/IBMQuery",["require","exports","module","./IBMObject","../../utils","./error/IBMDataError","./comm/_DataServiceRequest"],function(a,b,c,d,e,f,g){function h(a){var b=new d(a.className);return b._updateWithServerVersion(a),b}function i(a){this.query={className:a}}var j=g.OP;return i.prototype={constructor:i,find:function(a,b){return b=b||{limit:0,offset:0},this.query.criteria=a,this.query.options=b,this._doQuery(this.query).then(function(a){var b=a.map(h);return Q.resolve(b)})},_doQuery:function(a){return this.requester.send(a,j.QUERY)}},Object.defineProperties(i.prototype,{requester:{enumerable:!1,get:function(){return this.__req||(this.__req=g.getRequester()),this.__req},set:function(a){this.__req=a}},__req:{enumerable:!1,writable:!0}}),i}),d("ibm/baas/service/data/comm/RestRequest",["require","exports","module","../../../utils","./_DataServiceRequest","../error/IBMError"],function(a,b,c,d,e,f){function g(a,b){e.call(this,a),this.restUrl=this.serviceUrl.append("rest").append("v1").append("apps").append(b).toString(),this.bjax=IBMHttpRequest}var h=5e3,i=f.inherit({constructor:function(a,b,c){var d={message:a};b&&(d.status=b),c&&(d.data=c),f.call(this,d)}});return d.inherit(e,g,{bjax:null,send:function(a,b){if(!this._isValidObject(a,b))return Q.reject(new i("Object is invalid for given operation"));switch(b){case this.OP.CREATE:return this._createRequest(a);case this.OP.UPDATE:return this._updateRequest(a);case this.OP.DELETE:return this._deleteRequest(a);case this.OP.READ:return this._readRequest(a);case this.OP.QUERY:return this._queryRequest(a);default:return Q.reject(new i("Invalid operation provided: "+b))}},_meetsCriteria:function(a,b){b=b||{};var c=a.attributes||{};return Object.keys(b).every(function(a){return c[a]===b[a]})},_onRequestDone:function(a,b){function c(b){console.dir(b),b?"success"===b.status?a.resolve(b):a.reject(new i("Unhandled status",b.status,b)):a.reject(new i("No data returned"))}function d(b){a.reject(new i("Unexpected error when communicating with server",b))}b=b===!0||!1;return b?d:c},_request:function(a){var b=Q.defer(),c=this.restUrl+"/"+a.endpoint,d={url:c,timeout:h,method:a.method,handleAs:"json"};return a.payload&&(d.data=JSON.stringify(a.payload),d.contentType="json"),this.bjax(d).then(this._onRequestDone(b).bind(this),this._onRequestDone(b,!0).bind(this)),b.promise},_createRequest:function(a){var b={payload:[a.get()],method:"POST",endpoint:"injections?classname="+a.getClassName()};return this._request(b).then(this._getObjectFromResponse)},_getObjectFromResponse:function(a){var b=a&&a.object;return _.isArray(b)&&(b=a.object[0]),b?Q.resolve(b):Q.reject(new i("Response is missing created object",null,a))},_updateRequest:function(a){var b=a.getMetadata(),c=a.getId(),d={payload:{objectId:c,version:b.version,updates:a.get()},method:"PUT",endpoint:"objects/"+c};return this._request(d).then(this._getObjectFromResponse)},_deleteRequest:function(a){var b=a.getId(),c={method:"DELETE",endpoint:"objects/"+b};return this._request(c)},_readRequest:function(a){var b=a.getId(),c={method:"GET",endpoint:"objects/"+b};return this._request(c).then(this._getObjectFromResponse)},_queryRequest:function(a){var b={classname:a.className},c={endpoint:"objects?"+d.toQueryString(b),method:"GET"};return this._request(c).then(function(b){var c=b.object;return a.criteria&&(c=b.object.filter(function(b){return this._meetsCriteria(b,a.criteria)&&this._isValidServerVersionObject(b)}.bind(this))),Q.resolve(c)}.bind(this))},_isValidObject:function(a,b){if(b==this.OP.QUERY)return!0;var c=a.getMetadata(),e=["className"];return b==this.OP.UPDATE&&e.concat(["objectId","version"]),b==this.OP.DELETE&&e.push("objectId"),d.hasFields(c,e)},_isValidServerVersionObject:function(a){return d.hasFields(a,["objectId","className","version","attributes"])}}),g}),d("ibm/baas/service/data/IBMDataService",["require","exports","module","./IBMObject","./IBMQuery","./comm/_DataServiceRequest","./comm/RestRequest"],function(a,b,c,d,e){var f={Object:{ofType:function(a,b){var c=new d(a);return _.isObject(b)&&c.set(b),c}},Query:{ofType:function(a){return new e(a)}}};return f}),d("ibm/baas/service/IBMData",["require","exports","module","./data/IBMDataService","./data/comm/_DataServiceRequest","./data/comm/RestRequest"],function(a,c,d,e,f,g){var h=function(a,b,c,d,e,f){var g={VERSION:"0.3.2",endpoint:null,_data:null,initializeService:function(){if(!IBMBaaS&&!Q&&!IBMHttpRequest)throw new Error("IBMBaaS,Q,IBMHttpReqest are undefined.");var a=new IBMUriBuilder(IBMBaaS.getBaaSURL()).append("data"),b=IBMBaaS.getApplicationId(),c=new f(a,b);return e.setRequester(c),this._data=d,this._data},getVersion:function(){return this.VERSION},getService:function(){if(!this._data)throw new IBMError("Data Service not initialized. Call initializeService()");return this._data}};return g}.call(this,a,c,d,e,f,g),i=b.IBMData;return b.IBMData=h,h.noConflict=function(){return b.IBMData=i,h},h}),c("ibm/baas/service/IBMData")};return c?define(e):d?module.exports=e():e()}).call(this,"object"==typeof exports?global:window,"object"==typeof exports?global:window);